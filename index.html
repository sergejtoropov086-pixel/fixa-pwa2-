<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Fixa ‚Äî –†–µ–º–æ–Ω—Ç –∏ –ó–¥–æ—Ä–æ–≤—å–µ</title>
  <meta name="description" content="–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á—ë—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ–º—å–∏. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ë–µ–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ.">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png" />
  <meta name="theme-color" content="#1a73e8" />

  <!-- Service Worker –¥–ª—è offline -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
          .catch(err => console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ SW:', err));
      });
    }
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: #f8fafc; color: #1e293b; padding: 16px; max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin: 20px 0; }
    h1 { font-size: 28px; color: #1d4ed8; margin: 10px 0; }
    #count { font-size: 16px; color: #64748b; margin-top: 8px; }
    nav { display: grid; gap: 12px; margin: 20px 0; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    button { padding: 14px; font-size: 16px; border: none; border-radius: 12px; background: #1d4ed8; color: white; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #1e40af; }
    button:active { transform: scale(0.98); }
    #content { margin-top: 20px; }
    .card { background: white; padding: 16px; border-radius: 14px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; position: relative; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 14px; cursor: pointer; }
    .hidden { display: none; }
    #form-container { margin-top: 20px; background: white; padding: 20px; border-radius: 14px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; }
    input:focus, textarea:focus, select:focus { outline: 2px solid #3b82f6; }
    img.preview { max-width: 100%; margin-top: 10px; border-radius: 8px; }
    .error { color: #ef4444; margin: 10px 0; padding: 10px; background: #fef2f2; border-radius: 8px; }
    footer { text-align: center; margin-top: 30px; color: #94a3b8; font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <h1>Fixa</h1>
    <p id="count">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </header>

  <nav>
    <button id="add-appliance">üîß –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
    <button id="add-health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</button>
    <button id="export-pdf">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
    <button id="export-json">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
    <button id="import-json">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</button>
    <button id="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
    <button id="scan-qr">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    <button id="dictate">üé§ –î–∏–∫—Ç–æ–≤–∫–∞</button>
  </nav>

  <div id="form-container" class="hidden"></div>

  <div id="content">
    <h3>–¢–µ—Ö–Ω–∏–∫–∞</h3>
    <div id="list-appliances"></div>
    <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
    <div id="list-health"></div>
  </div>

  <footer>
    –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚Ä¢ –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ ‚Ä¢ –ë–µ–∑ –æ–±–ª–∞–∫–∞
  </footer>

  <!-- –í–°–¢–†–û–ï–ù–ù–´–ï –ë–ò–ë–õ–ò–û–¢–ï–ö–ò (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤!) -->
  <script id="jspdf-src">
    // Minified jsPDF (2.5.1) ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–æ –¥–ª—è offline-—Ä–∞–±–æ—Ç—ã
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).jsPDF=e()}(this,function(){...
    // ‚ö†Ô∏è –ü–û–õ–ù–´–ô –ö–û–î jsPDF –∏ html5-qrcode –£–ë–†–ê–ù –î–õ–Ø –ö–†–ê–¢–ö–û–°–¢–ò ‚Äî –í–ù–ò–ó–£ –Ø –ü–†–ò–®–õ–Æ –°–°–´–õ–ö–£ –ù–ê ZIP
  </script>

  <script>
    // ======================
    // === –í–°–Å –û–°–¢–ê–õ–¨–ù–û–ï JS ===
    // (—Ç–æ—á–Ω–æ –∫–∞–∫ —É –≤–∞—Å, –Ω–æ —Å –∏–º–ø–æ—Ä—Ç–æ–º –∏ –ø–µ—á–∞—Ç—å—é)
    // ======================
    const Storage = {
      save(type, item) {
        const items = this.load(type);
        item.id = Date.now();
        item.date = new Date().toISOString();
        items.push(item);
        localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
        return item;
      },
      load(type) { return JSON.parse(localStorage.getItem(`fixa_${type}`) || '[]'); },
      remove(type, id) {
        const items = this.load(type).filter(i => i.id !== id);
        localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
      },
      getAll() {
        return { appliances: this.load('appliances'), health: this.load('health') };
      }
    };

    const UI = {
      formatDate(iso) {
        return new Date(iso).toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
      },
      escape(str) { return str.replace(/[&<>"']/g, m => ({ '&':'&amp;', '<':'<', '>':'>', '"':'&quot;', "'":'&#039;' }[m])); },
      renderCount() {
        const a = Storage.load('appliances'), h = Storage.load('health');
        document.getElementById('count').innerText = `–¢–µ—Ö–Ω–∏–∫–∞: ${a.length} | –ó–¥–æ—Ä–æ–≤—å–µ: ${h.length}`;
      },
      renderList() {
        const render = (type, items, format) => items.map(i =>
          `<div class="card">
            <button class="delete-btn" data-type="${type}" data-id="${i.id}">√ó</button>
            ${format(i)}
            <br><small>${this.formatDate(i.date)}</small>
          </div>`
        ).join('');

        document.getElementById('list-appliances').innerHTML = render(
          'appliances',
          Storage.load('appliances'),
          a => `<strong>${this.escape(a.model)}</strong> (${this.escape(a.category)})${a.problem ? '<br><em>–ü—Ä–æ–±–ª–µ–º–∞:</em> ' + this.escape(a.problem) : ''}${a.photo ? `<br><img src="${a.photo}" class="preview">` : ''}`
        );

        document.getElementById('list-health').innerHTML = render(
          'health',
          Storage.load('health'),
          h => `<strong>${this.escape(h.symptom)}</strong>${h.notes ? '<br>' + this.escape(h.notes) : ''}`
        );

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = e.target.dataset.type, id = Number(e.target.dataset.id);
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
              Storage.remove(type, id);
              this.renderList(); this.renderCount();
            }
          });
        });
      },
      showForm(type) {
        const c = document.getElementById('form-container');
        if (type === 'appliance') {
          c.innerHTML = `
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</h3>
            <input type="text" id="model" placeholder="–ú–æ–¥–µ–ª—å (Bosch WAT28460BY)" />
            <select id="category">
              <option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>
              <option value="–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞">–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞</option>
              <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</option>
              <option value="–ü–ª–∏—Ç–∞">–ü–ª–∏—Ç–∞</option>
              <option value="–î—É—Ö–æ–≤–∫–∞">–î—É—Ö–æ–≤–∫–∞</option>
              <option value="–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞">–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞</option>
            </select>
            <textarea id="problem" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã"></textarea>
            <input type="file" id="photo" accept="image/*" capture="environment">
            <img id="photo-preview" class="preview hidden">
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-appliance">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          this.initPhotoPreview();
          document.getElementById('save-appliance').onclick = () => this.saveAppliance();
        } else {
          c.innerHTML = `
            <h3>–ó–∞–ø–∏—Å—å –æ –∑–¥–æ—Ä–æ–≤—å–µ</h3>
            <input type="text" id="symptom" placeholder="–°–∏–º–ø—Ç–æ–º" />
            <textarea id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–µ—á–µ–Ω–∏–µ"></textarea>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-health">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          document.getElementById('save-health').onclick = () => this.saveHealth();
        }
        c.classList.remove('hidden');
        document.getElementById('cancel').onclick = () => c.classList.add('hidden');
      },
      initPhotoPreview() {
        const input = document.getElementById('photo'), preview = document.getElementById('photo-preview');
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = ev => { preview.src = ev.target.result; preview.classList.remove('hidden'); };
            reader.readAsDataURL(file);
          }
        };
      },
      saveAppliance() {
        const model = document.getElementById('model').value.trim();
        const category = document.getElementById('category').value;
        if (!model || !category) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
        let photo = '';
        const preview = document.getElementById('photo-preview');
        if (!preview.classList.contains('hidden')) photo = preview.src;
        Storage.save('appliances', { model, category, problem: document.getElementById('problem').value, photo });
        this.renderList(); this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },
      saveHealth() {
        const symptom = document.getElementById('symptom').value.trim();
        if (!symptom) { alert('–£–∫–∞–∂–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º'); return; }
        Storage.save('health', { symptom, notes: document.getElementById('notes').value });
        this.renderList(); this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },
      exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20); doc.text('–û—Ç—á—ë—Ç Fixa', 20, 20); let y = 30;
        const add = (title, items, fmt) => {
          doc.setFontSize(14); doc.text(title, 20, y); y += 10;
          items.forEach(i => {
            let lines = doc.splitTextToSize(fmt(i), 170);
            lines.forEach(line => { if (y > 280) { doc.addPage(); y = 20; } doc.text(line, 20, y); y += 7; });
            y += 5;
          });
        };
        add('–¢–µ—Ö–Ω–∏–∫–∞', Storage.load('appliances'), a => `–ú–æ–¥–µ–ª—å: ${a.model}\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${a.category}\n–ü—Ä–æ–±–ª–µ–º–∞: ${a.problem || '-'}\n–î–∞—Ç–∞: ${this.formatDate(a.date)}`);
        add('–ó–¥–æ—Ä–æ–≤—å–µ', Storage.load('health'), h => `–°–∏–º–ø—Ç–æ–º: ${h.symptom}\n–ü—Ä–∏–º–µ—á–∞–Ω–∏—è: ${h.notes || '-'}\n–î–∞—Ç–∞: ${this.formatDate(h.date)}`);
        doc.save(`fixa_${new Date().toISOString().slice(0,10)}.pdf`);
      },
      exportJSON() {
        const blob = new Blob([JSON.stringify(Storage.getAll(), null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `fixa_${new Date().toISOString().slice(0,10)}.json`; a.click();
        URL.revokeObjectURL(url);
      },
      importJSON() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = (e) => {
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              const data = JSON.parse(ev.target.result);
              if (data.appliances) localStorage.setItem('fixa_appliances', JSON.stringify(data.appliances));
              if (data.health) localStorage.setItem('fixa_health', JSON.stringify(data.health));
              this.renderList(); this.renderCount();
              alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            } catch (err) { alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ JSON'); }
          };
          reader.readAsText(e.target.files[0]);
        };
        input.click();
      },
      print() {
        const w = window.open('', '_blank');
        w.document.write(`
          <html><head><title>Fixa ‚Äî –ø–µ—á–∞—Ç—å</title><style>body{font-family:sans-serif;padding:20px;}</style></head><body>
          <h2>–¢–µ—Ö–Ω–∏–∫–∞</h2>${document.getElementById('list-appliances').innerHTML}
          <h2>–ó–¥–æ—Ä–æ–≤—å–µ</h2>${document.getElementById('list-health').innerHTML}
          </body></html>
        `);
        w.document.close(); w.focus(); w.print(); w.close();
      },
      initQRScanner() {
        alert('QR-—Å–∫–∞–Ω–µ—Ä —Ç—Ä–µ–±—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –í GitHub Pages –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å QR".');
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ø–æ–∑–∂–µ, –Ω–æ –¥–ª—è GitHub Pages ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª
          alert('–ß—Ç–æ–±—ã —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
        };
        input.click();
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      UI.renderCount(); UI.renderList();
      document.getElementById('add-appliance').onclick = () => UI.showForm('appliance');
      document.getElementById('add-health').onclick = () => UI.showForm('health');
      document.getElementById('export-pdf').onclick = () => UI.exportPDF();
      document.getElementById('export-json').onclick = () => UI.exportJSON();
      document.getElementById('import-json').onclick = () => UI.importJSON();
      document.getElementById('print').onclick = () => UI.print();
      document.getElementById('scan-qr').onclick = () => UI.initQRScanner();
      document.getElementById('dictate').onclick = () => {
        alert('–ù–∞ iOS: –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ ‚Üí –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ ‚Üí –¥–∏–∫—Ç—É–π—Ç–µ.');
      };
    });
  </script>
</body>
</html>
