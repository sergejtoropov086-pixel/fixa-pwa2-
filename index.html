<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Fixa ‚Äî –†–µ–º–æ–Ω—Ç –∏ –ó–¥–æ—Ä–æ–≤—å–µ</title>
  <meta name="description" content="–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á—ë—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ–º—å–∏. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ë–µ–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ.">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png" />
  <meta name="theme-color" content="#1a73e8" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: #f8fafc; color: #1e293b; padding: 16px; max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin: 20px 0; }
    h1 { font-size: 28px; color: #1d4ed8; margin: 10px 0; }
    #count { font-size: 16px; color: #64748b; margin-top: 8px; }
    nav { display: grid; gap: 12px; margin: 20px 0; }
    button { padding: 14px; font-size: 16px; border: none; border-radius: 12px; background: #1d4ed8; color: white; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #1e40af; }
    button:active { transform: scale(0.98); }
    #content { margin-top: 20px; }
    .card { background: white; padding: 16px; border-radius: 14px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; position: relative; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 14px; cursor: pointer; }
    .hidden { display: none; }
    #form-container { margin-top: 20px; background: white; padding: 20px; border-radius: 14px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; }
    input:focus, textarea:focus, select:focus { outline: 2px solid #3b82f6; }
    img.preview { max-width: 100%; margin-top: 10px; border-radius: 8px; }
    .error { color: #ef4444; margin: 10px 0; padding: 10px; background: #fef2f2; border-radius: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Fixa</h1>
    <p id="count">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </header>

  <nav>
    <button id="add-appliance">üîß –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
    <button id="add-health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</button>
    <button id="export-pdf">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
    <button id="export-json">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
    <button id="scan-qr">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    <button id="dictate">üé§ –î–∏–∫—Ç–æ–≤–∫–∞ (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)</button>
  </nav>

  <div id="form-container" class="hidden">
    <!-- –§–æ—Ä–º—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
  </div>

  <div id="content">
    <h3>–¢–µ—Ö–Ω–∏–∫–∞</h3>
    <div id="list-appliances"></div>
    <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
    <div id="list-health"></div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    // === –•–†–ê–ù–ï–ù–ò–ï ===
    const Storage = {
      save(type, item) {
        const items = this.load(type);
        item.id = Date.now();
        item.date = new Date().toISOString();
        items.push(item);
        localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
        return item;
      },
      load(type) {
        const data = localStorage.getItem(`fixa_${type}`);
        return data ? JSON.parse(data) : [];
      },
      remove(type, id) {
        const items = this.load(type).filter(i => i.id !== id);
        localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
      },
      getAll() {
        return {
          appliances: this.load('appliances'),
          health: this.load('health')
        };
      }
    };

    // === UI ===
    const UI = {
      formatDate(isoString) {
        return new Date(isoString).toLocaleString('ru-RU', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      },

      renderCount() {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');
        document.getElementById('count').innerText = `–¢–µ—Ö–Ω–∏–∫–∞: ${appliances.length} | –ó–∞–ø–∏—Å–∏ –æ –∑–¥–æ—Ä–æ–≤—å–µ: ${health.length}`;
      },

      renderList() {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');

        document.getElementById('list-appliances').innerHTML = appliances.map(a =>
          `<div class="card">
            <button class="delete-btn" data-type="appliances" data-id="${a.id}">√ó</button>
            <strong>${this.escape(a.model)}</strong> (${a.category})<br>
            ${a.problem ? '<br><em>–ü—Ä–æ–±–ª–µ–º–∞:</em> ' + this.escape(a.problem) : ''}
            ${a.photo ? `<br><img src="${a.photo}" class="preview">` : ''}
            <br><small>${this.formatDate(a.date)}</small>
          </div>`
        ).join('');

        document.getElementById('list-health').innerHTML = health.map(h =>
          `<div class="card">
            <button class="delete-btn" data-type="health" data-id="${h.id}">√ó</button>
            <strong>${this.escape(h.symptom)}</strong><br>
            ${h.notes ? '<br>' + this.escape(h.notes) : ''}
            <br><small>${this.formatDate(h.date)}</small>
          </div>`
        ).join('');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = e.target.dataset.type;
            const id = Number(e.target.dataset.id);
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
              Storage.remove(type, id);
              this.renderList();
              this.renderCount();
            }
          });
        });
      },

      escape(str) {
        return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '<', '>': '>', '"': '&quot;', "'": '&#039;' }[m]));
      },

      showForm(type) {
        const container = document.getElementById('form-container');
        if (type === 'appliance') {
          container.innerHTML = `
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</h3>
            <input type="text" id="model" placeholder="–ú–æ–¥–µ–ª—å (Bosch WAT28460BY)" />
            <select id="category">
              <option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>
              <option value="–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞">–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞</option>
              <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</option>
              <option value="–ü–ª–∏—Ç–∞">–ü–ª–∏—Ç–∞</option>
              <option value="–î—É—Ö–æ–≤–∫–∞">–î—É—Ö–æ–≤–∫–∞</option>
              <option value="–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞">–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞</option>
            </select>
            <textarea id="problem" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ —Å–∏–º–ø—Ç–æ–º—ã"></textarea>
            <input type="file" id="photo" accept="image/*" capture="environment">
            <img id="photo-preview" class="preview hidden">
            <div style="display:flex;gap:10px;">
              <button id="save-appliance">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          this.initPhotoPreview();
          document.getElementById('save-appliance').onclick = () => this.saveAppliance();
        } else {
          container.innerHTML = `
            <h3>–ó–∞–ø–∏—Å—å –æ –∑–¥–æ—Ä–æ–≤—å–µ</h3>
            <input type="text" id="symptom" placeholder="–°–∏–º–ø—Ç–æ–º –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ" />
            <textarea id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–µ—á–µ–Ω–∏–µ –∏ —Ç.–¥."></textarea>
            <div style="display:flex;gap:10px;">
              <button id="save-health">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          document.getElementById('save-health').onclick = () => this.saveHealth();
        }
        container.classList.remove('hidden');
        document.getElementById('cancel').onclick = () => container.classList.add('hidden');
      },

      initPhotoPreview() {
        const input = document.getElementById('photo');
        const preview = document.getElementById('photo-preview');
        input.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              preview.src = event.target.result;
              preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        });
      },

      saveAppliance() {
        const model = document.getElementById('model').value.trim();
        const category = document.getElementById('category').value;
        const problem = document.getElementById('problem').value;
        if (!model || !category) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }

        let photo = '';
        const preview = document.getElementById('photo-preview');
        if (!preview.classList.contains('hidden')) {
          photo = preview.src;
        }

        Storage.save('appliances', { model, category, problem, photo });
        this.renderList();
        this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },

      saveHealth() {
        const symptom = document.getElementById('symptom').value.trim();
        const notes = document.getElementById('notes').value;
        if (!symptom) { alert('–£–∫–∞–∂–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º'); return; }
        Storage.save('health', { symptom, notes });
        this.renderList();
        this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },

      exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.text('–û—Ç—á—ë—Ç Fixa', 20, 20);
        let y = 30;

        const addSection = (title, items, format) => {
          doc.setFontSize(14);
          doc.text(title, 20, y); y += 10;
          items.forEach(item => {
            let lines = doc.splitTextToSize(format(item), 170);
            lines.forEach(line => {
              if (y > 280) { doc.addPage(); y = 20; }
              doc.text(line, 20, y);
              y += 7;
            });
            y += 5;
          });
        };

        addSection('–¢–µ—Ö–Ω–∏–∫–∞', Storage.load('appliances'), a =>
          `–ú–æ–¥–µ–ª—å: ${a.model}\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${a.category}\n–ü—Ä–æ–±–ª–µ–º–∞: ${a.problem || '-'}\n–î–∞—Ç–∞: ${this.formatDate(a.date)}`
        );
        addSection('–ó–¥–æ—Ä–æ–≤—å–µ', Storage.load('health'), h =>
          `–°–∏–º–ø—Ç–æ–º: ${h.symptom}\n–ü—Ä–∏–º–µ—á–∞–Ω–∏—è: ${h.notes || '-'}\n–î–∞—Ç–∞: ${this.formatDate(h.date)}`
        );

        doc.save(`fixa_${new Date().toISOString().slice(0,10)}.pdf`);
      },

      exportJSON() {
        const data = Storage.getAll();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fixa_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      },

      initQRScanner() {
        const div = document.createElement('div');
        div.id = 'qr-modal';
        div.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10000;background:black;';
        document.body.appendChild(div);

        const html5QrCode = new Html5Qrcode('qr-modal');
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          (text) => {
            html5QrCode.stop().then(() => {
              div.remove();
              document.getElementById('model').value = text;
              this.showForm('appliance');
            });
          },
          (err) => {
            html5QrCode.stop().then(() => {
              div.remove();
              // Fallback: –∑–∞–≥—Ä—É–∑–∫–∞ QR —Å —Ñ–æ—Ç–æ
              if (confirm('–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞. –•–æ—Ç–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å QR —Å —Ñ–æ—Ç–æ?')) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                  const file = e.target.files[0];
                  if (file) {
                    Html5Qrcode.scanFile(file, true)
                      .then(text => {
                        document.getElementById('model').value = text;
                        this.showForm('appliance');
                      })
                      .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR –Ω–∞ —Ñ–æ—Ç–æ'));
                  }
                };
                input.click();
              }
            });
          }
        ).catch(() => {
          div.remove();
          alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ "–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞".');
        });
      }
    };

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', () => {
      UI.renderCount();
      UI.renderList();

      document.getElementById('add-appliance').onclick = () => UI.showForm('appliance');
      document.getElementById('add-health').onclick = () => UI.showForm('health');
      document.getElementById('export-pdf').onclick = () => UI.exportPDF();
      document.getElementById('export-json').onclick = () => UI.exportJSON();
      document.getElementById('scan-qr').onclick = () => UI.initQRScanner();
      document.getElementById('dictate').onclick = () => {
        alert('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ iOS –¥–ª—è –¥–∏–∫—Ç–æ–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª—è—Ö.');
      };
    });
  </script>
</body>
</html>
