<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Fixa ‚Äî –†–µ–º–æ–Ω—Ç –∏ –ó–¥–æ—Ä–æ–≤—å–µ</title>
  <meta name="description" content="–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á—ë—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ–º—å–∏. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ë–µ–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ.">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png" />
  <meta name="theme-color" content="#1a73e8" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: #f5f7fa; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 28px; color: #1a73e8; margin: 10px 0; }
    #count { font-size: 16px; color: #666; margin-top: 5px; }
    nav { display: grid; gap: 12px; margin: 20px 0; }
    button { padding: 14px; font-size: 16px; border: none; border-radius: 12px; background: #1a73e8; color: white; cursor: pointer; transition: 0.2s; }
    button:hover { opacity: 0.9; }
    #content { margin-top: 20px; }
    .card { background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    #form-container { margin-top: 20px; }
    input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
  </style>
</head>
<body>
  <header>
    <h1>Fixa</h1>
    <p id="count">–¢–µ—Ö–Ω–∏–∫–∞: 0 | –ó–∞–ø–∏—Å–∏ –æ –∑–¥–æ—Ä–æ–≤—å–µ: 0</p>
  </header>

  <nav>
    <button id="add-appliance">üîß –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
    <button id="add-health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</button>
    <button id="export-pdf">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
    <button id="export-json">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
    <button id="scan-qr">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    <button id="voice-input">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ (–ø—Ä–æ–±–ª–µ–º–∞)</button>
  </nav>

  <div id="form-container" class="hidden">
    <div id="form-appliance" class="hidden">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</h3>
      <input type="text" id="model" placeholder="–ú–æ–¥–µ–ª—å (Bosch WAT28460BY)" />
      <select id="category">
        <option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>
        <option value="–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞">–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞</option>
        <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</option>
        <option value="–ü–ª–∏—Ç–∞">–ü–ª–∏—Ç–∞</option>
        <option value="–î—É—Ö–æ–≤–∫–∞">–î—É—Ö–æ–≤–∫–∞</option>
        <option value="–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞">–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞</option>
      </select>
      <textarea id="problem" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ —Å–∏–º–ø—Ç–æ–º—ã"></textarea>
      <input type="file" id="photo" accept="image/*" capture="environment">
      <button id="save-appliance">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="form-health" class="hidden">
      <h3>–ó–∞–ø–∏—Å—å –æ –∑–¥–æ—Ä–æ–≤—å–µ</h3>
      <input type="text" id="symptom" placeholder="–°–∏–º–ø—Ç–æ–º –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ" />
      <textarea id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–µ—á–µ–Ω–∏–µ –∏ —Ç.–¥."></textarea>
      <button id="save-health">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="cancel-health">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div id="content">
    <h3>–¢–µ—Ö–Ω–∏–∫–∞</h3>
    <div id="list-appliances"></div>
    <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
    <div id="list-health"></div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // === –Ø–î–†–û ===
    class FixaDB {
      static getKey(type) { return `fixa_${type}`; }
      static save(type, data) {
        const items = this.load(type);
        data.id = Date.now();
        data.date = new Date().toLocaleString('ru-RU');
        items.push(data);
        localStorage.setItem(this.getKey(type), JSON.stringify(items));
        return data;
      }
      static load(type) {
        const data = localStorage.getItem(this.getKey(type));
        return data ? JSON.parse(data) : [];
      }
      static render() {
        const appliances = this.load('appliances');
        const health = this.load('health');
        document.getElementById('count').innerText = `–¢–µ—Ö–Ω–∏–∫–∞: ${appliances.length} | –ó–∞–ø–∏—Å–∏ –æ –∑–¥–æ—Ä–æ–≤—å–µ: ${health.length}`;
        
        document.getElementById('list-appliances').innerHTML = appliances.map(a => 
          `<div class="card"><strong>${a.model}</strong> (${a.category})<br>${a.problem || ''}</div>`
        ).join('');
        
        document.getElementById('list-health').innerHTML = health.map(h => 
          `<div class="card"><strong>${h.symptom}</strong><br>${h.notes || ''}<br><small>${h.date}</small></div>`
        ).join('');
      }
    }

    // === –ì–û–õ–û–° ===
    function startVoiceInput(callback) {
      if (!('webkitSpeechRecognition' in window)) {
        alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.start();
      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        callback(text);
      };
      recognition.onerror = () => alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
    }

    // === QR ===
    async function startQRScan(callback) {
      const div = document.createElement('div');
      div.id = 'qr-modal';
      div.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10000;background:black;';
      document.body.appendChild(div);

      const html5QrCode = new Html5Qrcode('qr-modal');
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (text) => {
            callback(text);
            html5QrCode.stop().then(() => div.remove());
          },
          (err) => {}
        );
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
        div.remove();
      }
    }

    // === PDF ===
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(20);
      doc.text('–û—Ç—á—ë—Ç Fixa', 20, 20);
      let y = 30;

      const addSection = (title, items, format) => {
        doc.setFontSize(14);
        doc.text(title, 20, y); y += 10;
        items.forEach(item => {
          let text = format(item);
          doc.setFontSize(12);
          doc.text(text, 20, y);
          y += 8;
          if (y > 280) { doc.addPage(); y = 20; }
        });
        y += 10;
      };

      addSection('–¢–µ—Ö–Ω–∏–∫–∞', FixaDB.load('appliances'), a => `${a.model} ‚Äî ${a.category}\n  –ü—Ä–æ–±–ª–µ–º–∞: ${a.problem || '-'}`);
      addSection('–ó–¥–æ—Ä–æ–≤—å–µ', FixaDB.load('health'), h => `${h.symptom}\n  ${h.notes || ''}\n  (${h.date})`);

      doc.save(`fixa_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    // === –≠–ö–°–ü–û–†–¢ JSON ===
    function exportJSON() {
      const data = { appliances: FixaDB.load('appliances'), health: FixaDB.load('health') };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fixa_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', () => {
      FixaDB.render();

      // –ö–Ω–æ–ø–∫–∏
      document.getElementById('add-appliance').onclick = () => {
        document.querySelectorAll('#form-container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('form-appliance').classList.remove('hidden');
        document.getElementById('form-container').classList.remove('hidden');
      };

      document.getElementById('add-health').onclick = () => {
        document.querySelectorAll('#form-container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('form-health').classList.remove('hidden');
        document.getElementById('form-container').classList.remove('hidden');
      };

      document.getElementById('cancel').onclick = document.getElementById('cancel-health').onclick = () => {
        document.getElementById('form-container').classList.add('hidden');
      };

      document.getElementById('save-appliance').onclick = () => {
        const model = document.getElementById('model').value.trim();
        const category = document.getElementById('category').value;
        const problem = document.getElementById('problem').value;
        if (!model || !category) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
        FixaDB.save('appliances', { model, category, problem });
        FixaDB.render();
        document.getElementById('form-container').classList.add('hidden');
        document.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
      };

      document.getElementById('save-health').onclick = () => {
        const symptom = document.getElementById('symptom').value.trim();
        const notes = document.getElementById('notes').value;
        if (!symptom) { alert('–£–∫–∞–∂–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º'); return; }
        FixaDB.save('health', { symptom, notes });
        FixaDB.render();
        document.getElementById('form-container').classList.add('hidden');
        document.querySelectorAll('input, textarea').forEach(el => el.value = '');
      };

      document.getElementById('export-pdf').onclick = exportPDF;
      document.getElementById('export-json').onclick = exportJSON;
      document.getElementById('scan-qr').onclick = () => {
        startQRScan(text => {
          document.getElementById('model').value = text;
          document.getElementById('add-appliance').click();
        });
      };
      document.getElementById('voice-input').onclick = () => {
        startVoiceInput(text => {
          document.getElementById('problem').value = text;
        });
      };
    });
  </script>
</body>
</html>
